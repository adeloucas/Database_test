<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>House F Dataset Viewer</title>

  <!-- Tabulator CSS -->
  <link href="https://unpkg.com/tabulator-tables@5.5.0/dist/css/tabulator.min.css" rel="stylesheet">

  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 20px;
    }

    #detail-card {
      margin-top: 20px;
      padding: 15px;
      border: 1px solid #ccc;
      border-radius: 6px;
      background: #fafafa;
      display: grid;
      grid-template-columns: 1fr;
      gap: 12px;
    }

    .detail-section {
      padding: 10px;
      border-radius: 6px;
      background: #fff;
      border: 1px solid #e6e6e6;
    }

    .detail-title {
      font-weight: 700;
      margin-bottom: 6px;
      color: #222;
    }

    .detail-value {
      color: #111;
      line-height: 1.4;
    }

    .detail-row {
      margin-bottom: 6px;
    }

    .detail-label {
      font-weight: 600;
      color: #333;
      display: inline-block;
      width: 110px;
    }

    #search-input {
      width: 300px;
      padding: 6px;
      margin-bottom: 10px;
    }

    a.cdli-link {
      color: #0b66c3;
      text-decoration: none;
    }
  </style>
</head>

<body>

<h2>House F Dataset</h2>

<input id="search-input" type="text" placeholder="Searchâ€¦">

<div id="table"></div>

<h3>Record Details</h3>
<div id="detail-card">Click a row to view details.</div>

<!-- PapaParse for robust CSV parsing -->
<script src="https://unpkg.com/papaparse@5.4.1/papaparse.min.js"></script>
<!-- Tabulator JS -->
<script src="https://unpkg.com/tabulator-tables@5.5.0/dist/js/tabulator.min.js"></script>

<script>
  // Raw CSV URL (use raw.githubusercontent.com)
  const csvUrl = "https://raw.githubusercontent.com/adeloucas/Database_test/main/house%20f.csv";

  // Helper to render a labeled field only if value exists
  function renderField(label, value) {
    if (value === undefined || value === null) return "";
    const v = String(value).trim();
    if (v === "" || v === "-" ) return "";
    return `<div class="detail-row"><span class="detail-label">${label}</span><span class="detail-value">${escapeHtml(v)}</span></div>`;
  }

  // Escape HTML to avoid accidental markup injection
  function escapeHtml(str) {
    return String(str)
      .replace(/&/g, "&amp;")
      .replace(/</g, "&lt;")
      .replace(/>/g, "&gt;")
      .replace(/"/g, "&quot;")
      .replace(/'/g, "&#039;");
  }

  async function loadCSV() {
    const response = await fetch(csvUrl);
    const text = await response.text();

    const parsed = Papa.parse(text, {
      header: true,
      skipEmptyLines: true,
      dynamicTyping: false,
      transformHeader: h => h.trim()
    });

    return {
      headers: parsed.meta.fields || [],
      data: parsed.data || []
    };
  }

  loadCSV().then(({ headers, data }) => {
    // Build Tabulator columns from headers
    const columns = headers.map(h => ({
      title: h,
      field: h,
      headerFilter: false,
      width: 150
    }));

    const table = new Tabulator("#table", {
      data: data,
      layout: "fitDataFill",
      height: "500px",
      columns: columns,
      selectable: 1,
      reactiveData: true,
      rowClick: function (e, row) {
        const record = row.getData();
        const detailDiv = document.getElementById("detail-card");

        // Build grouped sections
        // Group 1: Year | Month | Day (using correct capitalization)
        const year = record["Year"] || "";
        const month = record["Month"] || "";
        const day = record["Day"] || "";
        let dateHtml = "";
        dateHtml += renderField("Year", year);
        dateHtml += renderField("Month", month);
        dateHtml += renderField("Day", day);

        // Group 2: Text ID (using correct capitalization)
        const textId = record["Text ID"] || "";
        let textIdHtml = "";
        if (textId && String(textId).trim() !== "") {
          textIdHtml += renderField("Text ID", textId);
        }

        // Group 3: Genre | Dossier (using correct capitalization)
        const genre = record["Genre"] || "";
        const dossier = record["Dossier"] || "";
        let genreHtml = "";
        genreHtml += renderField("Genre", genre);
        genreHtml += renderField("Dossier", dossier);

        // Group 4: CDLI (using correct capitalization)
        const cdli = record["CDLI"] || "";
        let cdliHtml = "";
        if (cdli && String(cdli).trim() !== "" && cdli !== "-") {
          const cdliEsc = escapeHtml(cdli);
          // Example CDLI link pattern
          let cdliLink = "";
          if (/^https?:\/\//i.test(cdli)) {
            cdliLink = `<a class="cdli-link" href="${cdliEsc}" target="_blank" rel="noopener noreferrer">${cdliEsc}</a>`;
          } else {
            // If cdli looks like an ID, link to CDLI search page
            cdliLink = `<a class="cdli-link" href="https://cdli.ucla.edu/search/search_results.php?SearchMode=Text&ObjectID=${encodeURIComponent(cdli)}" target="_blank" rel="noopener noreferrer">${cdliEsc}</a>`;
          }
          cdliHtml += `<div class="detail-row"><span class="detail-label">CDLI</span><span class="detail-value">${cdliLink}</span></div>`;
        }

        // Compose final HTML with sections, hide sections that are empty
        let finalHtml = "";

        if (dateHtml) {
          finalHtml += `<div class="detail-section"><div class="detail-title">Date Information</div>${dateHtml}</div>`;
        }

        if (textIdHtml) {
          finalHtml += `<div class="detail-section"><div class="detail-title">Text ID</div>${textIdHtml}</div>`;
        }

        if (genreHtml) {
          finalHtml += `<div class="detail-section"><div class="detail-title">Genre and Dossier</div>${genreHtml}</div>`;
        }

        if (cdliHtml) {
          finalHtml += `<div class="detail-section"><div class="detail-title">CDLI</div>${cdliHtml}</div>`;
        }

        // If nothing matched, show a fallback
        if (!finalHtml) {
          finalHtml = "<div class='detail-section'><div class='detail-title'>No details available</div></div>";
        }

        detailDiv.innerHTML = finalHtml;
      }
    });

    // Search box
    document.getElementById("search-input").addEventListener("keyup", function () {
      const query = this.value.toLowerCase();
      table.setFilter((row) => {
        return Object.values(row.getData()).some(v =>
          String(v).toLowerCase().includes(query)
        );
      });
    });
  }).catch(err => {
    document.getElementById("detail-card").innerText = "Error loading CSV: " + err.message;
    console.error(err);
  });
</script>

</body>
</html>
